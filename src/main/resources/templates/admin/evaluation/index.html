<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{admin/layouts/main}">
<head>
  <meta charset="UTF-8">
  <title>Tableau de Bord des Évaluations par Voiture</title>
  <style>
    .kpi-card {
      border-radius: 10px;
      background-color: #f8f9fa;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .kpi-title {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .chart-container {
      margin: 40px 0;
    }

    .car-photo {
        width: 100%;
        height: auto;
        max-height: 200px;
        object-fit: cover;
        border-radius: 10px;
    }

    .evaluation-card {
        margin-bottom: 20px;
        position: relative;
    }

    .star-rating {
        display: flex;
    }

    .star {
        font-size: 1.5rem;
        color: #ffc107;
    }

    .star.empty {
        color: #ddd;
    }

    .list-group-item {
        cursor: pointer;
    }

    .selected-item {
        background-color: #d3d3d3;
    }

    .no-data {
        text-align: center;
        color: #888;
        margin-top: 50px;
    }

    .no-data i {
        font-size: 48px;
        display: block;
        margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div layout:fragment="content" class="container mt-5">

  <!-- Section des KPI -->
  <div class="row">
    <div class="col-md-4">
      <div class="kpi-card">
        <div class="kpi-title">Total des Évaluations</div>
        <div class="kpi-value" id="kpi-total-evaluations">0</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi-card">
        <div class="kpi-title">Note Moyenne</div>
        <div class="kpi-value" id="kpi-average-rating">0</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi-card">
        <div class="kpi-title">Total des Voitures</div>
        <div class="kpi-value" id="kpi-total-cars">0</div>
      </div>
    </div>
  </div>

  <!-- Section du graphique -->
  <div class="row chart-container">
    <div class="col-md-12">
      <canvas id="evaluationChart" class="chart"></canvas>
    </div>
  </div>

  <!-- Section des voitures et évaluations -->
  <div class="row mt-4">
    <div class="col-md-4">
      <ul class="list-group" id="car-list">
        <!-- Liste des voitures dynamiques -->
      </ul>
    </div>
    <div class="col-md-8">
      <div id="car-evaluations-container" class="row">
        <!-- Évaluations dynamiques -->
      </div>
    </div>
  </div>

  <script>
   document.addEventListener('DOMContentLoaded', function() {
      // Charger les données du tableau de bord des évaluations
      loadEvaluationDashboardData();

      // Charger la liste des voitures ayant des évaluations
      loadCarListWithEvaluations();

      // Gestion du clic sur une voiture pour afficher ses évaluations
      document.getElementById('car-list').addEventListener('click', function(e) {
          let clickedElement = e.target.closest('li');
          if (clickedElement) {
              let carId = clickedElement.getAttribute('data-car-id');
              if (carId && carId !== 'undefined') {
                  fetchCarEvaluations(carId);

                  // Mettre à jour l'état sélectionné
                  document.querySelectorAll('#car-list .list-group-item').forEach(item => item.classList.remove('selected-item'));
                  clickedElement.classList.add('selected-item');
              } else {
                  console.error('Car ID is undefined or invalid:', carId);
              }
          }
      });
  });

  async function loadEvaluationDashboardData() {
      try {
          const response = await fetch('/api/admin/evaluations/dashboard');
          const data = await response.json();

          // Mettre à jour les KPI
          updateEvaluationKPI(data);

          // Afficher le graphique des évaluations par jour
          displayEvaluationChart(data.evaluationsByDay);
      } catch (error) {
          console.error("Erreur lors du chargement des données du tableau de bord des évaluations:", error);
      }
  }

  function updateEvaluationKPI(data) {
      document.getElementById('kpi-total-evaluations').textContent = data.totalEvaluations;
      document.getElementById('kpi-average-rating').textContent = data.averageRating.toFixed(2);
      document.getElementById('kpi-total-cars').textContent = data.totalCars;
  }

  function displayEvaluationChart(evaluationsByDay) {
      const weeklyData = {};

      Object.keys(evaluationsByDay).forEach(date => {
          const dateObj = new Date(date);
          const weekInfo = getWeekRange(dateObj);

          // Utilisez la plage de dates comme label
          const weekLabel = `${weekInfo.start.toLocaleDateString('fr-FR')} - ${weekInfo.end.toLocaleDateString('fr-FR')}`;

          if (!weeklyData[weekLabel]) {
              weeklyData[weekLabel] = 0;
          }
          weeklyData[weekLabel] += evaluationsByDay[date];
      });

      const labels = Object.keys(weeklyData);
      const data = Object.values(weeklyData);

      const ctx = document.getElementById('evaluationChart').getContext('2d');
      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Nombre d\'évaluations par semaine',
                  data: data,
                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
              }]
          },
          options: {
              scales: {
                  y: { beginAtZero: true }
              },
              responsive: true
          }
      });
  }

  // Fonction pour obtenir la plage de dates d'une semaine donnée
  function getWeekRange(date) {
      const startOfWeek = new Date(date.setDate(date.getDate() - date.getDay() + 1)); // Commence lundi
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6); // Fin dimanche

      return {
          start: startOfWeek,
          end: endOfWeek
      };
  }

  async function loadCarListWithEvaluations() {
      try {
          const response = await fetch('/api/admin/evaluations');
          const evaluations = await response.json();

          const carMap = new Map();

          evaluations.forEach(evaluation => {
              if (evaluation.carId && evaluation.carBrand && evaluation.carModel) { // Vérification que carId est présent
                  const carKey = evaluation.carBrand + ' ' + evaluation.carModel;
                  if (!carMap.has(carKey)) {
                      carMap.set(carKey, {
                          id: evaluation.carId,
                          carBrand: evaluation.carBrand,
                          carModel: evaluation.carModel
                      });
                  }
              } else {
                  console.error('Données invalides pour une voiture:', evaluation);
              }
          });

          const carList = document.getElementById('car-list');
          carList.innerHTML = ''; // Vide la liste avant ajout

          carMap.forEach(car => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item';
              listItem.setAttribute('data-car-id', car.id);
              listItem.textContent = `${car.carBrand} ${car.carModel}`;
              carList.appendChild(listItem);
          });
      } catch (error) {
          console.error("Erreur lors du chargement des voitures:", error);
      }
  }

  async function fetchCarEvaluations(carId) {
      try {
          const response = await fetch(`/api/admin/evaluations/car/${carId}`);
          const evaluations = await response.json();

          const container = document.getElementById('car-evaluations-container');
          container.innerHTML = '';  // Vide les anciennes évaluations

          if (evaluations.length === 0) {
              container.innerHTML = `
                  <div class="no-data">
                      <i class="fas fa-inbox"></i>
                      <p>Pas d'évaluations</p>
                  </div>
              `;
          } else {
              evaluations.forEach(evaluation => {
                  const evaluationCard = `
                      <div class="col-md-12 mb-3">
                          <div class="card evaluation-card">
                              <div class="card-body d-flex">
                                  <img src="${'/uploads/profil/' + evaluation.userProfilePhotoUrl}" class="evaluation-profile rounded-circle me-2" height="100" alt="User profile">
                                  <div>
                                      <h5 class="card-title">${evaluation.userPrenom} ${evaluation.userNom}</h5>
                                      <div class="star-rating">
                                          ${[...Array(5)].map((_, i) => i < evaluation.note ? '<span class="star">&#9733;</span>' : '<span class="star empty">&#9733;</span>').join('')}
                                      </div>
                                      <p class="card-text">${evaluation.avis}</p>
                                      <p class="card-textpç"><small class="text-muted">${new Date(evaluation.createdAt).toLocaleDateString('fr-FR')}</small></p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  `;
                  container.insertAdjacentHTML('beforeend', evaluationCard);
              });
          }
      } catch (error) {
          console.error("Erreur lors du chargement des évaluations de la voiture:", error);
      }
  }
  </script>
</div>
</body>
</html>
