<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" layout:decorate="~{admin/layouts/main}">
<head>
  <meta charset="UTF-8">
  <title>Évaluations par Voiture</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .car-photo {
        width: 100%;
        height: auto;
        max-height: 200px;
        object-fit: cover;
        border-radius: 10px;
    }
    .card{
         border-radius: 10px;
    }
    .car-item {
        margin-bottom: 20px;
        text-align: center;
    }
    .evaluation-carousel .carousel-item {
        padding: 20px;
    }
    .evaluation-profile {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
    }
    .evaluation-card {
        margin-bottom: 20px;
        position: relative;
    }
    .star-rating {
        display: flex;
    }

    .star {
        font-size: 1.5rem;
        color: #ffc107; /* Couleur dorée */
    }

    .star.empty {
        color: #ddd; /* Couleur gris clair pour les étoiles vides */
    }

    .delete-button {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        color: red;
        font-size: 1.5rem;
        z-index: 10;
    }

    .delete-button i {
        color: #dc3545;
    }

    .imgCar-eval{
        border-radius: 10px;
    }

    .search-bar {
        margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div layout:fragment="content" class="container mt-5">

  <!-- Barre de recherche -->
  <input type="text" id="search-bar" class="form-control search-bar" placeholder="Rechercher une voiture par marque ou modèle...">

  <div id="car-evaluation-container" class="row">
    <!-- Contenu chargé par JavaScript -->
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        let carsMap = new Map();
        fetch('/api/admin/evaluations')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('car-evaluation-container');

                carsMap = new Map();
                data.forEach(evaluation => {
                    const carKey = `${evaluation.carBrand}-${evaluation.carModel}`;
                    if (!carsMap.has(carKey)) {
                        carsMap.set(carKey, {
                            photoUrl: evaluation.carPhotoUrl,
                            brand: evaluation.carBrand,
                            model: evaluation.carModel,
                            evaluations: []
                        });
                    }
                    carsMap.get(carKey).evaluations.push(evaluation);
                });

                renderCars(carsMap);
            })
            .catch(error => console.error('Erreur lors du chargement des évaluations:', error));

        // Événement de recherche
        document.getElementById('search-bar').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const filteredCarsMap = new Map([...carsMap].filter(([key, car]) =>
                car.brand.toLowerCase().includes(query) || car.model.toLowerCase().includes(query)
            ));
            renderCars(filteredCarsMap);
        });
    });

    function renderCars(carsMap) {
        const container = document.getElementById('car-evaluation-container');
        container.innerHTML = '';  // Clear the container before rendering

        carsMap.forEach((car, carKey) => {
            const carItem = document.createElement('div');
            carItem.classList.add('col-md-12', 'mb-4');

            const carouselId = `evaluationCarousel-${carKey.replace(/\s+/g, '-')}`;

            const carouselInner = document.createElement('div');
            carouselInner.classList.add('carousel-inner');

            car.evaluations.forEach((evaluation, index) => {
                const carouselItem = document.createElement('div');
                carouselItem.classList.add('carousel-item');
                if (index === 0) {
                    carouselItem.classList.add('active');
                }

                carouselItem.innerHTML = `
                    <div class="evaluation-card card">
                      <div class="card-body d-flex">
                        <img src="${'/uploads/profil/' + evaluation.userProfilePhotoUrl}" class="evaluation-profile" alt="User profile">
                        <div>
                          <h5 class="card-title">${evaluation.userPrenom} ${evaluation.userNom}</h5>
                          <div class="star-rating">
                            ${[...Array(5)].map((_, i) => i < evaluation.note ? '<span class="star">&#9733;</span>' : '<span class="star empty">&#9733;</span>').join('')}
                          </div>
                          <p class="card-text">${evaluation.avis}</p>
                          <p class="card-text"><small class="text-muted">${new Date(evaluation.createdAt).toLocaleDateString('fr-FR')}</small></p>
                        </div>
                        <div class="delete-button" data-evaluation-id="${evaluation.id}">
                          <i class="fas fa-trash"></i>
                        </div>
                      </div>
                    </div>
                    `;

                carouselInner.appendChild(carouselItem);
            });

            carItem.innerHTML = `
                <div class="row">
                  <div class="col-md-4">
                    <img src="${'/uploads' + car.photoUrl}" alt="${car.brand} ${car.model}" class="car-photo img-fluid">
                    <h5 class="text-center mt-2">${car.brand} ${car.model}</h5>
                  </div>
                  <div class="col-md-8">
                    <div id="${carouselId}" class="carousel slide evaluation-carousel" data-ride="carousel" data-interval="5000">
                      <div class="carousel-inner">
                        ${carouselInner.innerHTML}
                      </div>
                      <a class="carousel-control-prev" href="#${carouselId}" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                      </a>
                      <a class="carousel-control-next" href="#${carouselId}" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                      </a>
                    </div>
                  </div>
                </div>
            `;

            container.appendChild(carItem);
        });

        // Ajout de l'événement pour supprimer une évaluation
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function() {
                const evaluationId = this.dataset.evaluationId;
                if (confirm('Voulez-vous vraiment supprimer cette évaluation ?')) {
                    deleteEvaluation(evaluationId, this.closest('.carousel-item'));
                }
            });
        });
    }

    function deleteEvaluation(evaluationId, carouselItem) {
        fetch(`/api/admin/evaluations/${evaluationId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la suppression de l\'évaluation.');
            }

            const carouselInner = carouselItem.parentNode;
            const activeIndex = Array.from(carouselInner.children).indexOf(carouselItem);
            carouselItem.remove();

            if (carouselInner.children.length === 0) {
                // Supprimer tout le carrousel si c'était le seul élément
                const carItem = carouselInner.closest('.col-md-12');
                carItem.remove();
            } else {
                // Si l'élément supprimé était actif, il faut activer un autre élément
                if (carouselItem.classList.contains('active')) {
                    const nextItem = carouselInner.children[activeIndex] || carouselInner.children[0];
                    nextItem.classList.add('active');
                }
            }

            alert('Évaluation supprimée avec succès.');
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur s\'est produite lors de la suppression de l\'évaluation.');
        });
    }
</script>
</div>

</body>
</html>
