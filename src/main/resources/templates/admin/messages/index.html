<!DOCTYPE html>
<html lang="fr" xmlns:layout="http://www.ultraq.net.mx/thymeleaf/layout" layout:decorate="~{admin/layouts/main}">
<head>
  <meta charset="UTF-8">
  <title>Admin Tableau de Bord</title>
  <style>
    .kpi-card {
      border-radius: 10px;
      background-color: #f8f9fa;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .kpi-title {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .chart-container {
      margin: 40px 0;
    }

    .list-group-item {
      cursor: pointer;
    }

    .selected-item {
      background-color: #d3d3d3;
    }

    .no-data {
      text-align: center;
      color: #888;
      margin-top: 50px;
    }

    .no-data i {
      font-size: 48px;
      display: block;
      margin-bottom: 10px;
    }

  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="container mt-5">
    <h2>Tableau de Bord de l'Administrateur</h2>

    <!-- Section des KPI -->
    <div class="row">
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">Total des Discussions</div>
          <div class="kpi-value" id="kpi-total-messages">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">Total des Notifications</div>
          <div class="kpi-value" id="kpi-total-notifications">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">Total des Plaintes</div>
          <div class="kpi-value" id="kpi-total-complaints">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">Réservations Critiques</div>
          <div class="kpi-value" id="kpi-critical-reservations">0</div>
        </div>
      </div>
    </div>

    <!-- Graphique des Messages et Notifications par Jour -->
    <div class="row chart-container">
      <div class="col-md-12">
        <canvas id="messageNotificationBarChart"></canvas>
      </div>
    </div>

    <!-- Section des Messages et Notifications -->
    <div class="row mt-4">
      <div class="col-md-4">
        <ul class="list-group" id="user-list">
          <!-- Utilisateurs dynamiques ayant des messages ou notifications -->
        </ul>
      </div>
      <div class="col-md-8">
        <ul class="nav nav-tabs" id="messageNotificationTabs">
          <li class="nav-item">
            <a class="nav-link active" id="messages-tab" data-bs-toggle="tab" href="#messages">Messages</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="notifications-tab" data-bs-toggle="tab" href="#notifications">Notifications</a>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Messages Tab -->
          <div id="messages" class="tab-pane fade show active">
            <div id="chat-messages" class="row"></div>
          </div>

          <!-- Notifications Tab -->
          <div id="notifications" class="tab-pane fade">
            <div id="user-notifications" class="row"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", function() {
      loadDashboardData();
      loadUserListWithMessagesOrNotifications();

      // Gestion du clic sur les utilisateurs
      document.querySelector('#user-list').addEventListener('click', function(e) {
          let clickedElement = e.target.closest('li');
          if (clickedElement) {
              let userId = clickedElement.getAttribute('data-user-id');
              fetchMessages(userId);
              fetchNotifications(userId);

              // Mettre à jour l'état sélectionné
              document.querySelectorAll('#user-list .list-group-item').forEach(item => item.classList.remove('selected-item'));
              clickedElement.classList.add('selected-item');
          }
      });

      // Changement de tabs Messages/Notifications
      document.querySelectorAll('#messageNotificationTabs a').forEach(tab => {
          tab.addEventListener('click', function(e) {
              e.preventDefault();
              const target = e.target.getAttribute('href');
              document.querySelector('.tab-pane.show.active').classList.remove('show', 'active');
              document.querySelector(target).classList.add('show', 'active');
          });
      });
  });

 async function loadDashboardData() {
    try {
        const response = await fetch('/api/admin/messages/kpi');
        const data = await response.json();

        // Vérifiez que les données sont présentes
        const messagesByDay = data.messagesByDay || {};
        const notificationsByDay = data.notificationsByDay || {};

        // Afficher les données dans le graphique
        displayBarChart(messagesByDay, notificationsByDay);

        // Mise à jour des KPI
        updateKPI(data);
    } catch (error) {
        console.error("Erreur lors du chargement des données du tableau de bord:", error);
    }
}

  function updateKPI(data) {
      document.getElementById('kpi-total-messages').textContent = data.totalChats;
      document.getElementById('kpi-total-notifications').textContent = data.totalNotifications;
  }

 function displayBarChart(messagesByDay = { '2024-08-01': 5, '2024-08-02': 7, '2024-08-03': 3 }, notificationsByDay = { '2024-08-01': 2, '2024-08-02': 4, '2024-08-03': 6 }) {
    const ctx = document.getElementById('messageNotificationBarChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(messagesByDay), // Les jours
            datasets: [
                {
                    label: 'Messages',
                    data: Object.values(messagesByDay), // Données des messages
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Notifications',
                    data: Object.values(notificationsByDay), // Données des notifications
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            responsive: true
        }
    });
}

  async function loadUserListWithMessagesOrNotifications() {
      try {
          const response = await fetch('/api/admin/messages/users-with-messages-or-notifications');
          const users = await response.json();

          const userList = document.getElementById('user-list');
          userList.innerHTML = ''; // Vide la liste avant ajout

          users.forEach(user => {
              const listItem = document.createElement('li');
              listItem.className = 'list-group-item';
              listItem.setAttribute('data-user-id', user.id);
              listItem.textContent = `${user.prenom} ${user.nom}`;
              userList.appendChild(listItem);
          });
      } catch (error) {
          console.error("Erreur lors du chargement des utilisateurs:", error);
      }
  }

  async function fetchMessages(userId) {
      try {
          const response = await fetch(`/api/admin/messages/chats?userId=${userId}`);
          const messages = await response.json();
          const messageContainer = document.getElementById('chat-messages');
          messageContainer.innerHTML = ''; // Vide les anciens messages

          if (Array.isArray(messages) && messages.length === 0) {
              messageContainer.innerHTML = `
                  <div class="no-data">
                      <i class="fas fa-inbox"></i>
                      <p>Pas de messages</p>
                  </div>
              `;
          } else if (Array.isArray(messages)) {
              messages.forEach(message => {
                  const messageCard = `
                      <div class="col-md-12 mb-3">
                          <div class="card">
                              <div class="card-body">
                                  <h5 class="card-title">${message.content}</h5>
                                  <p class="card-text"><small class="text-muted">Envoyé le ${message.sentAt}</small></p>
                              </div>
                          </div>
                      </div>`;
                  messageContainer.insertAdjacentHTML('beforeend', messageCard);
              });
          }
      } catch (error) {
          console.error("Erreur lors du chargement des messages:", error);
      }
  }

  async function fetchNotifications(userId) {
      try {
          const response = await fetch(`/api/admin/messages/notifications?userId=${userId}`);
          const notifications = await response.json();
          const notificationContainer = document.getElementById('user-notifications');
          notificationContainer.innerHTML = ''; // Vide les anciennes notifications

          if (Array.isArray(notifications) && notifications.length === 0) {
              notificationContainer.innerHTML = `
                  <div class="no-data">
                      <i class="fas fa-bell"></i>
                      <p>Pas de notifications</p>
                  </div>
              `;
          } else if (Array.isArray(notifications)) {
              notifications.forEach(notification => {
                  const notificationCard = `
                      <div class="col-md-12 mb-3">
                          <div class="card">
                              <div class="card-body">
                                  <p class="card-text">${notification.message}</p>
                                  <p class="card-text"><small class="text-muted">Reçue le ${notification.sentAt}</small></p>
                              </div>
                          </div>
                      </div>`;
                  notificationContainer.insertAdjacentHTML('beforeend', notificationCard);
              });
          }
      } catch (error) {
          console.error("Erreur lors du chargement des notifications:", error);
      }
  }
</script>
</div>

</body>
</html>
